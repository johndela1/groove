<script>
  function beep() {
      var hz = 200;
      var cx = new AudioContext()
      var o = cx.createOscillator()
      o.type = "sine"
      o.frequency.setValueAtTime(hz, cx.currentTime);
      o.connect(cx.destination)
      o.start(cx.currentTime);
      o.stop(cx.currentTime+.001);
  }

  function deltas(song, msPerBeat) {
     var  beatsSinceNote=1;
      var dts = [];
      for (b=1; b<song.length; b++) {
          //reverse  remove !
          if (song[b]==0) {
              beatsSinceNote+=1;
	  } else {
              dts.push(msPerBeat * beatsSinceNote);
              beatsSinceNote=1;
	  }
      }
      return dts
  }

  prev = null;
  note_idx = 0;
  errors = [];
  is_first = true;
  const average = arr => arr.reduce((a,b) => a + b, 0) / arr.length;

  function note() {
      if (is_first) {
	  st = Date.now();
	  setTimeout(() => {
	      let xhr = new XMLHttpRequest();
	      avg = average(errors);
	      if (avg > 0) {
		  console.log("too slow", avg);
	      } else {
		  console.log("too fast", avg);
	      }
	      xhr.open("POST", "http://localhost:8000");
	      xhr.setRequestHeader("Content-Type", "application/json");
	      var payload = [song.join(''), bpm, errors].join('|');
	      console.log(payload);
	      xhr.send(payload)
	  }, msPerBeat * song.length);
	  is_first = false;
      }
      now = Date.now()
      if (prev == null) {
	  prev = now;
	  return;
      }
      errors.push(now - prev - dts[note_idx++]);
      prev = now;
  }
  function start() {
      for (let b = 0; b< song.length; b++) {
	  if (song[b] != 0) {
	      setTimeout(() => {
		  beep();
	      }, msPerBeat * b)
	  }
      }
  }

  song = [1,1,0,1];
  song = Array(1).fill([1,1,0,1,1,0,1,0]).flat();
 // song = [1,0,1,0,1,1,0,1,0,1,1];
  // song = [1,0,     1,0, 0,0 ,1,0      ,1,0, 0,1, 1,0];
  //song = [1,0, 0,0, 0,0,   1,0, 0,1, 1,0];

  bpm = 240
  const SECS_IN_MIN = 60;
  msPerBeat = SECS_IN_MIN*1000/bpm;
  dts = deltas(song, msPerBeat);
  document.addEventListener('keydown', (e) => {
      switch(e.key) {
      case 'n':
	  location.reload();
	  break;
      case ' ':
	  note();
	  break;
      case 'x':
	  start();
	  break;
      }
  });
</script>
